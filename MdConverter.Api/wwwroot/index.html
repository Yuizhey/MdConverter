<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Renderer</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<div class="container">
    <h1>Markdown Renderer</h1>

    <div class="button-container">
        <button id="loginButton" onclick="location.href='login.html'">Войти</button>
        <button id="registerButton" onclick="location.href='Register.html'">Зарегистрироваться</button>
        <button id="logoutButton" disabled>Выйти</button>
    </div>

    <div class="main-container">
        <div class="left-column">
            <div class="markdown-container">
                <textarea id="markdownText" placeholder="Введите ваш Markdown здесь..."></textarea>
                <button id="convertButton">Конвертировать</button>
                <textarea id="renderedHtml" readonly>Результат отрендеренного Markdown будет здесь...</textarea>
            </div>
        </div>

        <div class="right-column">
            <button id="getDocumentsButton">Получить документы</button>
            <ul id="documentsList"></ul>

            <!-- Поле для ввода названия документа -->
            <label for="documentName">Введите название для документа:</label>
            <input type="text" id="documentName" placeholder="Введите название документа...">

            <!-- Кнопки для сохранения и скачивания -->
            <button id="saveButton" class="secondary-button">Сохранить</button>
            <button id="downloadButton" class="secondary-button">Скачать HTML</button>
            <button id="openInNewWindowButton" class="secondary-button">Открыть в новом окне</button>
        </div>
    </div>
</div>

<script src="/js/Markdown.js"></script>
<script src="/js/AuthorizeCheck.js"></script>
<script >
    document.getElementById('logoutButton').addEventListener('click', async function () {
        try {
            const response = await fetch('/Account/Logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                document.cookie = 'token=; Max-Age=0; path=/';
                document.getElementById('logoutButton').disabled = true;
                location.href = '/index.html';
            } else {
                alert('Ошибка при выходе');
            }
        } catch (error) {
            console.error('Ошибка сети или сервера:', error);
            alert('Произошла ошибка при выходе.');
        }
    });

    document.getElementById('getDocumentsButton').addEventListener('click', async function () {
        try {
            const token = document.cookie.split('; ').find(row => row.startsWith('token')).split('=')[1];

            const response = await fetch('/Document/GetAllDocumentsByUserName', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            });

            if (response.ok) {
                const documents = await response.json();
                const list = document.getElementById('documentsList');
                list.innerHTML = ''; // Очищаем текущий список

                documents.forEach(doc => {
                    const li = document.createElement('li');
                    li.textContent = doc.name;

                    // Добавляем обработчик клика для получения содержимого
                    li.addEventListener('click', async () => {
                        await loadDocumentContent(doc.name);
                    });

                    list.appendChild(li); // Добавляем элемент в список
                });
            } else {
                alert('Ошибка при получении документов');
            }
        } catch (error) {
            console.error('Ошибка при запросе документов:', error);
            alert('Произошла ошибка при загрузке документов.');
        }
    });

    async function loadDocumentContent(documentName) {
        try {
            const token = document.cookie.split('; ').find(row => row.startsWith('token')).split('=')[1];

            const response = await fetch(`/Document/GetDocumentContent?documentName=${documentName}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            });

            if (response.ok) {
                const { content } = await response.json();
                document.getElementById('markdownText').value = content;
                document.getElementById('documentName').value = documentName; // Устанавливаем имя документа
            } else {
                alert('Ошибка при загрузке содержимого документа');
            }
        } catch (error) {
            console.error('Ошибка при загрузке содержимого документа:', error);
            alert('Произошла ошибка при загрузке содержимого документа.');
        }
    }


    async function deleteDocument(documentId) {
        try {
            const token = document.cookie.split('; ').find(row => row.startsWith('token')).split('=')[1];

            const response = await fetch(`/Document/DeleteDocument?documentId=${documentId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                },
            });

            if (response.ok) {
                alert('Документ успешно удален');
                document.getElementById('getDocumentsButton').click(); // Обновляем список документов
            } else {
                alert('Ошибка при удалении документа');
            }
        } catch (error) {
            console.error('Ошибка при удалении документа:', error);
            alert('Произошла ошибка при удалении документа.');
        }
    }


    document.getElementById('downloadButton').addEventListener('click', function () {
        const htmlContent = document.getElementById('renderedHtml').value;
        const documentName = document.getElementById('documentName').value || "renderedMarkdown";

        const blob = new Blob([htmlContent], { type: 'text/html' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${documentName}.html`;
        link.click();
    });

    document.getElementById('openInNewWindowButton').addEventListener('click', function () {
        const htmlContent = document.getElementById('renderedHtml').value;

        const newWindow = window.open('', '_blank');
        newWindow.document.write(`
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Отрендеренный Markdown</title>
        </head>
        <body>
            ${htmlContent}
        </body>
        </html>
    `);
        newWindow.document.close();
    });

    document.getElementById('saveButton').addEventListener('click', async function () {
        const markdownText = document.getElementById('markdownText').value;
        const fileName = document.getElementById('documentName').value || "renderedMarkdown";

        if (!markdownText) {
            alert("Пожалуйста, введите текст Markdown.");
            return;
        }

        try {
            const token = document.cookie.split('; ').find(row => row.startsWith('token')).split('=')[1];

            const response = await fetch('/Document/CreateDocument', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify({
                    Name: fileName,
                    MarkdownText: markdownText
                })
            });

            if (response.ok) {
                alert('Документ успешно сохранен!');
            } else {
                alert('Ошибка при сохранении документа');
            }
        } catch (error) {
            console.error('Ошибка при сохранении документа:', error);
            alert('Произошла ошибка при сохранении документа.');
        }
    });

</script>
</body>
</html>
